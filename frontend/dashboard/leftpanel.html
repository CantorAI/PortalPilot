<!DOCTYPE html>
<html>
<head>
    <title>Design Studio - leftpanel </title>   
    <script src="/c/users/victor/projects/CantorAI/Galaxy/Javascript/parse_dataframe.js"></script>
    <script src="/c/users/victor/projects/CantorAI/Galaxy/Javascript/draw.js"></script>
    <script src="/c/users/victor/projects/CantorAI/Cantor/src/WebEngine/cantor.ws.js"></script>
    <script>
        var socket = new CantorWebSocket("ws://localhost:8080");
        socket.connect();
        const filterList = [];

        async function FetchfilterList_old() {
            //filterList = [];
            //filterList.length = 0;
            //document.getElementById("output").innerHTML = "FetchfilterList() called"; 
            while(filterList.length > 0) {
                filterList.pop();
            }

            let retVal = await socket.call("retrieveFilterList");
            if (retVal == null || retVal.length < 2) {
                return;
            }
            let data = retVal[1];
            if (data == null) {
                return;
            }
			else {

                let output = '';
                document.getElementById('output_filterList').innerHTML = '';
                data = JSON.parse(retVal);
                // Display top categories 
                for (let cat in data) {
                     output += `<h4>${cat}</h4>`;
                    // output += `${cat}`;
                    // Display middle level items
                    for (let i=0; i<data[cat].length; i++) {
                        let filterType = Object.keys(data[cat][i])[0];
                        let filterDesignPage  = data[cat][i][filterType]["designpage "];  //padding space is needed
                        let filterDll  = data[cat][i][filterType]["uri "];
                        let filterDesc = "'" //support spaces in description field
                        filterDesc += data[cat][i][filterType]["desription "];
                        filterDesc += "'" 
                        if (i % 2 == 0) {//2 items on each row 
                            output += "<p>";
                        }
                        //output += "<button onclick='new"
                        //output += filterType
                        //output += "()'>" 
                        //output += filterType;
                        //output += "</button>";

                        /*
                        output += "<button onclick='newFilter(\\042";
                        output += filterType;
                        output += "\\042,\\042"
                        output += filterDll;
                        output += "\\042,\\042"
                        output += filterDesc
                        output += "\\042)'>" ;
                        output += filterType;
                        output += "</button>";
                        */

                        output += "<button onclick='newFilter(&quot;";
                        output += filterType;
                        output += "&quot;,&quot;"
                        output += filterDll;
                        output += "&quot;,&quot;"
                        output += filterDesc
                        output += "&quot;)'>" ;
                        output += filterType;
                        output += "</button>";

                        if (i % 2 != 0) {
                            output += "</p>";
                        }
                        // filterList.push({filterType, filterDll})
                        filterList.push(filterType)
                    }                    
                }
                document.getElementById('output_filterList').innerHTML = output;            
                updateSelect();
			}
        } //FetchfilterList_Old

        async function FetchfilterList() {
            //filterList = [];
            //filterList.length = 0;
            //document.getElementById("output").innerHTML = "FetchfilterList() called"; 
            while(filterList.length > 0) {
                filterList.pop();
            }

            let retVal = await socket.call("retrieveFilterList");
            if (retVal == null || retVal.length < 2) {
                return;
            }
            let data = retVal[1];
            if (data == null) {
                return;
            }
			else {

                let output = '';
                document.getElementById('output_filterList').innerHTML = '';
                data = JSON.parse(retVal);
                // Display top categories 
                for (let cat in data) {
                     output += `<h4>${cat}</h4>`;
                     // Display middle level items
                    for (let i=0; i<data[cat].length; i++) {
                        //output = "";
                        let filterType = Object.keys(data[cat][i])[0];
                        let filterDesignPage  = data[cat][i][filterType]["designpage "];  //padding space is needed
                        let filterDll  = data[cat][i][filterType]["uri "];
                        let filterDesc = "'" //support spaces in description field
                        filterDesc += data[cat][i][filterType]["desription "];
                        filterDesc += "'" 
                        if (i % 2 == 0) {//2 items on each row 
                            output += "<p>";
                        }
                        output += "<button onclick='newFilter(";
                        output += "&quot;"
                        output += filterType
                        output += "&quot;"
                        output += ","
                        output += "&quot;"
                        output += filterDll
                        output += "&quot;"
                        output += ")'>" 
                        output += filterType;
                        output += "</button>";
                        if (i % 2 != 0 || (i == data[cat].length - 1)) {
                            output += "</p>";
                        }
                        // filterList.push({filterType, filterDll})
                        filterList.push(filterType)
                    }                    
                }
                document.getElementById('output_filterList').innerHTML += output;            
                updateSelect();
			}
        } //FetchfilterList

        var actMap = '{}';
        mgr = null;
        const nodeGraph_key = "nodeGraph";

        function init() {
            if ( _datastore == null) 
                _datastore = new Map();
            if (typeof _datastore !== "undefined") {
                if (_datastore.has(nodeGraph_key)) {
                    mgr = _datastore.get(nodeGraph_key);
                    mgr.reInit(idGraphDrawPad, actMap);
                }
                else {
                    mgr = new GraphManager(idGraphDrawPad, actMap);
                    _datastore.set(nodeGraph_key, mgr);
                }
            }
            else {
                mgr = new GraphManager(idGraphDrawPad, actMap);
            }
        }

        init();

        async function newFilter_old(filterType, filterDll, filterDesc) {
            alert ("newFilter: " + filterType );
            document.getElementById("output").innerHTML = "to create a " + filterType; 
            inputPins = await socket.call("retrieveFilterPins", filterType, filterDll, true);
            outputPins = await socket.call("retrieveFilterPins", filterType, filterDll, false);
            let pinStr = '[\
                {\
                    "Name": "output",\
                        "Dir": "out",\
                            "frametypes": [\
                                "any"\
                            ]\
                }\
            ]';
            if (mgr == null){
                document.getElementById("output").innerHTML = "mgr is null, can not call mgr.newObj"; 
                init();
            }
            mgr.newObj(filterType, filterDesc, pinStr);
        }    
        async function newFilter(filterType, filterDll) {
            document.getElementById("output").innerHTML = "to create a " + filterType + "!"; 
            //inputPins = await socket.call("retrieveFilterPins", filterType, filterDll, 1);  //don't use bool or string for the pin type
            //outputPins = await socket.call("retrieveFilterPins", filterType, filterDll, 0);
            filterDllWords = filterDll.split(".");
            filterDllShort = filterDllWords[0].trim(); // remove .dll & leading/padding spaces 
            filterTypeShort = filterType.trim(); // remove spaces
            alert (filterDllShort+filterTypeShort)
            filterPropertyList = await socket.call("retrieveFilterPropertyListbyType", filterTypeShort, filterDllShort);//not work, why?
            //filterPropertyList = await socket.call("retrieveFilterPropertyListbyType", "dataset", "galaxy_dataset");//working 
            output = "";
            for(let i=0; i<filterPropertyList.length; i++) {
                    output += '<b>Name:</b> ' + filterPropertyList[i].get('name') + '<br>';
                    output += '<b>Type:</b> ' + filterPropertyList[i].get('type') + '<br>';
                    output += '<b>Doc:</b> '  + filterPropertyList[i].get('doc')  + '<br><br>';
            }                
            document.getElementById("output").innerHTML = output; 

            pinStr = "";
            if (filterType == "dataset ")
                pinStr = '[\
                {\
                    "Name": "output",\
                        "Dir": "out",\
                            "frametypes": [\
                                "any"\
                            ]\
                }\
                ]';
            else if (filterType == "sink ")
                pinStr = '[\
                {\
                    "Name": "input",\
                        "Dir": "in",\
                            "frametypes": [\
                                "any"\
                            ]\
                }\
                ]';
            else if (filterType == "fermat ")
                pinStr = '[\
                {\
                    "Name": "input",\
                        "Dir": "in",\
                            "frametypes": [\
                                "any"\
                            ]\
                },\
                {\
                    "Name": "output",\
                        "Dir": "out",\
                            "frametypes": [\
                                "any"\
                            ]\
                }\
            ]';
            else if (filterType == "llmAgent ")
                pinStr = '[\
                    {\
                        "Name": "input",\
                            "Dir": "in",\
                                "frametypes": [\
                                    "any"\
                                ]\
                    },\
                    {\
                        "Name": "output",\
                            "Dir": "out",\
                                "frametypes": [\
                                    "any"\
                                ]\
                    }\
                ]';
            else if (filterType == "prompt ")
                pinStr = '[\
                    {\
                        "Name": "input",\
                            "Dir": "in",\
                                "frametypes": [\
                                    "any"\
                                ]\
                    },\
                    {\
                        "Name": "output",\
                            "Dir": "out",\
                                "frametypes": [\
                                    "any"\
                                ]\
                    }\
                ]';
            else if (filterType == "health ")
                pinStr = '[\
                    {\
                        "Name": "input",\
                            "Dir": "in",\
                                "frametypes": [\
                                    "any"\
                                ]\
                    },\
                    {\
                        "Name": "output",\
                            "Dir": "out",\
                                "frametypes": [\
                                    "any"\
                                ]\
                    }\
                ]';
            else if (filterType == "tee ")
                pinStr = '[\
                    {\
                        "Name": "input",\
                            "Dir": "in",\
                                "frametypes": [\
                                    "any"\
                                ]\
                    },\
                    {\
                        "Name": "output1",\
                            "Dir": "out",\
                                "frametypes": [\
                                    "any"\
                                ]\
                    },\
                    {\
                        "Name": "output2",\
                            "Dir": "out",\
                                "frametypes": [\
                                    "any"\
                                ]\
                    }\
                ]';            
            else if (filterType == "mux ")
                pinStr = '[\
                    {\
                        "Name": "input1",\
                            "Dir": "in",\
                                "frametypes": [\
                                    "any"\
                                ]\
                    },\
                    {\
                        "Name": "input2",\
                            "Dir": "in",\
                                "frametypes": [\
                                    "any"\
                                ]\
                    },\
                    {\
                        "Name": "output",\
                            "Dir": "out",\
                                "frametypes": [\
                                    "any"\
                                ]\
                    }\
                ]';

            if (mgr == null){
                document.getElementById("output").innerHTML = "mgr is null, can not call mgr.newObj"; 
                init();
            }
            //objType = filterType.charAt(0).toUpperCase() + string.slice(1);
            //mgr.newObj(objType, "", pinStr);
            mgr.newObj(filterType, "", pinStr);
        }    

        function deleteCurObj() {
            if (mgr == null){
                //alert ("mgr is null, can not call mgr.newObj");
                document.getElementById("output").innerHTML = "mgr is null, can not call mgr.deleteCurObj"; 
                init();
            }
            mgr.deleteCurObj();
        }

    </script>
</head>

<body>
    <!--
    <div id="output_filterList" onload="FetchfilterList()"></div>
    -->
    <div>
        <p> <h4>Builtin Models(Filters)</h4></p>
    </div>
    <div>
        <button onclick="FetchfilterList()">Fetch Filter List</button>
    </div>
    <div id="output_filterList"></div>
    <p> ------------------------</p>
    <div> <button onclick="deleteCurObj();">Delete</button></div>
    <p> ------------------------</p>
    <div> 
        <p> <h4>Download Third Party Models </h4></p>
        <p><a href="https://huggingface.co/">Hugging Face</a></p>
        <p><a href="https://civitai.com/">Civitai</a></p>
        <p><a href="https://discord.com/">Discord</a></p>
        <p><a href="https://www.modelzoo.co/">Model Zoo </a></p>
    </div>
    
</body>
</html>
